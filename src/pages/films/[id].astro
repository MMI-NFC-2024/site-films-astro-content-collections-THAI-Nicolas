---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { render } from "astro:content";
import { formatDate, joinWithAnd, getRegionName } from "../../helper.ts";
import { Image } from "astro:assets";
import LinkPersonnes from "../../components/LinkPersonnes.astro";
import { getEntry } from "astro:content";
import { getEntries } from "astro:content";

export async function getStaticPaths() {
    const films = await getCollection("films");
    return films.map(film => ({
        params: {id: film.id},
        props: {film}
    }))
}

const { film } = Astro.props;
const  { Content } = await render(film);
const rolesEntries = film.data.roles ? await Promise.all(film.data.roles.map( async ({acteur,nom_role})=>({
    nom_role,
    acteur: await getEntry(acteur)
}))) : []



---

<Layout titre={`${film.data.titre}`}>
    <!-- Breadcrumbs -->
    <div class="breadcrumbs text-sm mb-6">
        <ul>
            <li><a href="/">Accueil</a></li>
            <li><a href="/films">Films</a></li>
            <li>{film.data.titre}</li>
        </ul>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Colonne gauche: Affiche -->
        <div class="lg:col-span-1">
            {film.data.affiche && (
                <div class="card bg-base-100 shadow-xl">
                    <figure>
                        <Image 
                            src={film.data.affiche} 
                            alt={`Affiche du film ${film.data.titre}`}
                            class="w-full rounded-xl"
                        />
                    </figure>
                </div>
            )}
            
            <!-- Informations rapides -->
            <div class="card bg-base-200 shadow-xl mt-4">
                <div class="card-body">
                    <h3 class="card-title text-lg">Informations</h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <div>
                                <div class="text-xs opacity-60">Date de sortie</div>
                                <div class="font-semibold">{formatDate(film.data.dateSortie)}</div>
                            </div>
                        </div>
                        <div class="divider my-0"></div>
                        <div class="flex items-start gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                            <div>
                                <div class="text-xs opacity-60">Genres</div>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    {film.data.genre.map((g: string) => (
                                        <div class="badge badge-primary badge-sm">{g}</div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        {film.data.pays && (
                            <>
                                <div class="divider my-0"></div>
                                <div class="flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
                                    </svg>
                                    <div>
                                        <div class="text-xs opacity-60">Pays</div>
                                        <div class="font-semibold">{getRegionName(film.data.pays)}</div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne droite: Détails -->
        <div class="lg:col-span-2">
            <!-- Titre -->
            <h1 class="text-4xl md:text-5xl font-bold mb-6">{film.data.titre}</h1>

            <!-- Réalisateur -->
            {film.data.realisateur && (
                <div class="card bg-base-200 shadow-md mb-4">
                    <div class="card-body py-4">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                            <span class="text-sm opacity-70">Réalisateur:</span>
                            <LinkPersonnes personne={await getEntry(film.data.realisateur)} />
                        </div>
                    </div>
                </div>
            )}

            <!-- Producteurs -->
            {film.data.producteurs && film.data.producteurs.length > 0 && (
                <div class="card bg-base-200 shadow-md mb-4">
                    <div class="card-body py-4">
                        <div class="flex items-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <div class="flex-1">
                                <span class="text-sm opacity-70">Producteur{film.data.producteurs.length > 1 ? 's' : ''}:</span>
                                <div class="mt-1">
                                    {(await getEntries(film.data.producteurs))
                                        .map((prod) => <LinkPersonnes personne={prod} />)
                                        .reduce((prev, curr, currentIndex) => [
                                            prev,
                                            currentIndex < film.data.producteurs!.length - 1 ? ", " : " et ",
                                            curr,
                                        ])
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            <!-- Distribution -->
            {(film.data.acteurs || film.data.roles) && (
                <div class="card bg-base-200 shadow-md mb-6">
                    <div class="card-body">
                        <h3 class="card-title text-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            Distribution
                        </h3>
                        
                        {film.data.acteurs && (
                            <div class="mb-3">
                                {(await getEntries(film.data.acteurs))
                                    .map((personne) => <LinkPersonnes personne={personne} />)
                                    .reduce((p, c) => [p, ", ", c])
                                }
                            </div>
                        )}
                        
                        {film.data.roles && (
                            <div class="overflow-x-auto">
                                <table class="table table-sm">
                                    <tbody>
                                        {rolesEntries.map(({acteur, nom_role}) => (
                                            <tr>
                                                <td class="font-semibold"><LinkPersonnes personne={acteur} /></td>
                                                <td class="opacity-70">{nom_role}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            )}

            <!-- Synopsis / Description -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-xl mb-4">Synopsis</h3>
                    <div class="prose max-w-none">
                        <Content />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bouton retour -->
    <div class="mt-8">
        <a href="/films" class="btn btn-ghost gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Retour aux films
        </a>
    </div>
</Layout>